<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>Mnet 直播自动刷新</title>
<script src="https://cdn.jwplayer.com/libraries/IDzF9Zmk.js"></script>
</head>
<body>
<div id="video-player" style="width:100%;height:480px;"></div>

<script>
const API_ENDPOINT = "https://api.hypera.live/api/v3/science"; // 获取最新 m3u8 的接口
const REFRESH_INTERVAL = 120000; // 2分钟刷新一次 token
let player = null;

// 模拟请求 API 获取最新 play_url
async function fetchPlayUrl() {
    try {
        // ⚠️ 实际可用 API 需要你自己的 token 或 session
        // 这里用 fetch 模拟获取 JSON 数据
        const response = await fetch(API_ENDPOINT, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "x-parent-request-id": "自动生成或 Turnstile token"
            },
            body: JSON.stringify({ platform: "web", player: "jwplayer6" })
        });

        const data = await response.json();

        // data.play_url 中包含最新 m3u8
        if (data.play_url) {
            return data.play_url;
        } else if (data.video_streams && data.video_streams.length > 0) {
            return data.video_streams[0];
        } else {
            console.error("未获取到播放链接");
            return null;
        }
    } catch (err) {
        console.error("请求 play_url 出错", err);
        return null;
    }
}

// 初始化 JWPlayer 并播放
async function initPlayer() {
    const url = await fetchPlayUrl();
    if (!url) return;

    player = jwplayer("video-player").setup({
        file: url,
        width: "100%",
        height: 480,
        autostart: true,
        controls: true
    });

    // 播放错误自动刷新
    player.on("error", async () => {
        console.warn("播放错误，尝试刷新 token...");
        const newUrl = await fetchPlayUrl();
        if (newUrl) {
            player.load([{ file: newUrl }]);
            player.play();
        }
    });

    // 定时刷新 token 并更新 m3u8
    setInterval(async () => {
        console.log("定时刷新 play_url...");
        const newUrl = await fetchPlayUrl();
        if (newUrl && player) {
            player.load([{ file: newUrl }]);
        }
    }, REFRESH_INTERVAL);
}

// 启动
initPlayer();
</script>
</body>
</html>
